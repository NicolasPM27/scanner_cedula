# ════════════════════════════════════════════════════════════
# FOMAG Docker Compose — Único archivo de orquestación
# Variables: docker/.env → symlink a ../.env (raíz)
# ════════════════════════════════════════════════════════════

services:
  sqlserver:
    build:
      context: .
      dockerfile: Dockerfile.db
    container_name: fomag-sqlserver
    ports:
      - "${DB_PORT:-1433}:1433"
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${SA_PASSWORD}"
    volumes:
      - sqlserver-data:/var/opt/mssql
      - ./init:/docker-entrypoint-init
      - ./data:/data
    entrypoint: /bin/bash /docker-entrypoint-init/entrypoint.sh
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "SQLCMD=$$(command -v sqlcmd || echo /opt/mssql-tools18/bin/sqlcmd) && $$SQLCMD -S localhost -U sa -P \"${SA_PASSWORD}\" -C -No -Q 'SELECT 1'",
        ]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 40s
    cap_add:
      - SYS_PTRACE

  api:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: fomag-api
    ports:
      - "${PORT:-3000}:3000"
    environment:
      NODE_ENV: development
      PORT: "3000"
      DB_HOST: sqlserver
      DB_PORT: "1433"
      DB_USER: "${DB_USER:-sa}"
      DB_PASSWORD: "${SA_PASSWORD}"
      DB_NAME: "${DB_NAME:-fomag_poblacion}"
      DB_ENCRYPT: "${DB_ENCRYPT:-false}"
      DB_TRUST_SERVER_CERTIFICATE: "${DB_TRUST_SERVER_CERTIFICATE:-true}"
      CORS_ORIGIN: "${CORS_ORIGIN:-http://localhost:4200,http://localhost:8100,capacitor://localhost,http://localhost}"
    depends_on:
      sqlserver:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - api-uploads:/app/uploads

volumes:
  sqlserver-data:
  api-uploads:

 